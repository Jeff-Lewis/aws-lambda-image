#!/usr/bin/env node

var path       = require("path");
var fs         = require("fs");
var configPath = path.resolve(__dirname, "../config.json");
var projectDir = path.resolve(__dirname, "..");
var warning    = [];
var fatals     = [];
var stdout     = process.stdout;
var config;
var buffer;

var red     = '\u001b[31m';
var green   = '\u001b[32m';
var magenta = '\u001b[35m';
var yellow  = '\u001b[33m';
var reset   = '\u001b[0m';

(function() {

console.log(green + "==========================================" + reset);
console.log(green + "  AWS-Lambda-Image Configuration Checker"   + reset);
console.log(green + "==========================================" + reset);
stdout.write("\r\n");

if ( ! fs.existsSync(configPath) ) {
    stdout.write(red + "[Error] Config file not exists.\r\n" + reset);
    stdout.write(red + "Did you put a config file at " + projectDir + "/config.json?\r\n" + reset);
    return;
}

var eventFilename = process.argv[2];
if (eventFilename) {
	stdout.write(magenta + "Event filename:       " + yellow + eventFilename);
	stdout.write("\r\n");
	stdout.write("\r\n");
}

buffer = fs.readFileSync(configPath, {encoding: "utf8"});

stdout.write(magenta + "Configuration status: " + reset);
try {
    config = JSON.parse(buffer);
    stdout.write("OK\r\n");
} catch ( e ) {
    stdout.write(red + "Error!\r\n" + reset);
    console.log(e.message);
    process.exit(1);
}

stdout.write(magenta + "JPEG optimizer:       " + reset);
var optimizer = ( config.jpegOptimizer ) ? config.jpegOptimizer : "mozjpeg";
if ( optimizer !== "jpegoptim" && optimizer !== "mozjpeg" ) {
    warning.push("[Warning] JPEG Optimizer is invalid. It accepts 'jpegoptim' or 'mozjpeg'.");
    optimizer = "mozjpeg";
}
stdout.write(optimizer + "\r\n");

var bucket = ( config.bucket ) ? config.bucket : "";
stdout.write(magenta + "Destination bucket:   " + reset);
stdout.write(( bucket ) ? bucket : "[Same bucket]");
stdout.write("\r\n");

var acl = ("acl" in config ? config.acl : "");
if ( acl ) {
	acl = config.acl;

    stdout.write(magenta + "Global S3 ACL:        " + reset + acl);
    stdout.write("\r\n");
}
stdout.write("\r\n");

stdout.write("Backup image configuration\r\n");
stdout.write("--------------------------------\r\n");
if ( "backup" in config ) {
    var backup = config.backup || {};
    stdout.write(magenta + "    Save bucket:      " + reset);
    stdout.write(( backup.bucket ) ? backup.bucket : bucket ? bucket : "[Same bucket]");
    stdout.write("\r\n");
    stdout.write(magenta + "    Save directory:   " + reset);
    if ( "directory" in backup ) {
        stdout.write(backup.directory + ( /^\.\//.test(backup.directory) ) ? "[Relative]" : "");
    } else {
        stdout.write("[Same directory]");
    }
    stdout.write("\r\n");
    if ( ! backup.directory && ! backup.bucket && ! bucket ) {
        warning.push("Backuped image may save same bucket and directory. This doesn't make any sense.");
    }
	stdout.write(magenta + "    S3 ACL:           " + reset);
	stdout.write(( backup.acl ) ? backup.acl : acl ? "[Global ACL]" : "[Source ACL]");
	stdout.write("\r\n");
} else {
    stdout.write("Backup option is not supplied, skip it.\r\n");
}

stdout.write("\r\n");
stdout.write("Reduce image configuration\r\n");
stdout.write("--------------------------------\r\n");
if ( "reduce" in config ) {
    var reduce = config.reduce || {};
	if ( "quality" in reduce ) {
		if ( reduce.quality < 0 || reduce.quality > 100 ) {
			warning.push("'quality' option is illegal. this option must be in range 0-100.");
		} else {
			stdout.write(magenta + "    Image Quality:    " + reset);
			stdout.write(reduce.quality + " (JPG Only)");
			stdout.write("\r\n");
		}
	}
    stdout.write(magenta + "    Save bucket:      " + reset);
    stdout.write(( reduce.bucket ) ? reduce.bucket : bucket ? bucket : "[Same bucket]");
    stdout.write("\r\n");
    stdout.write(magenta + "    Save directory:   " + reset);
    if ( "directory" in reduce ) {
        stdout.write(reduce.directory + ( /^\.\//.test(reduce.directory) ) ? "[Relative]" : "");
    } else {
        stdout.write("[Same directory]");
    }
    stdout.write("\r\n");
    if ( ! reduce.directory && ! reduce.bucket && ! bucket ) {
        warning.push("Reduced image may save same bucket and directory. This causes infinite process AWS-Lambda.");
    }
    if ( "prefix" in reduce ) {
        stdout.write(magenta + "    Filename Prefix:  " + reset + reduce.prefix);
        stdout.write("\r\n");
    }
    if ( "suffix" in reduce ) {
        stdout.write(magenta + "    Filename Suffix:  " + reset + reduce.suffix);
        stdout.write("\r\n");
    }
	stdout.write(magenta + "    S3 ACL:           " + reset);
	stdout.write(( reduce.acl ) ? reduce.acl : acl ? "[Global ACL]" : "[Source ACL]");
	stdout.write("\r\n");
} else {
    stdout.write("Reduce option is not supplied, skip it.\r\n");
}

stdout.write("\r\n");
stdout.write("Resize image configuration\r\n");
stdout.write("--------------------------------\r\n");
var resizes = config.resizes || [];
stdout.write(magenta + "    Number of resize images: " + reset + resizes.length + "\r\n");
stdout.write("\r\n");
resizes.forEach(function(resize, index) {
    stdout.write("    Resize image " + (index + 1) + " ( of " + resizes.length + " )\r\n");
    stdout.write("    --------------------------------\r\n");
	if (eventFilename && eventFilename.indexOf(resize.directory) !== 0) {
		stdout.write(red + "We don't process images in the output folder");
		stdout.write("\r\n");
		return
	}
    stdout.write(magenta + "    Size:             " + reset + resize.size + "\r\n");
    if ( ! ("size" in resize) ) {
        fatals.push("Resize destination size must be supplied ( at index " + index + " )");
    } else if ( isNaN(parseInt(resize.size, 10)) ) {
        fatals.push("Resize destination size must be a number ( at index " + index + " )");
    }
	if ( "format" in resize ) {
		stdout.write(magenta + "    Convert:          " + reset + resize.format);
		stdout.write("\r\n");
	}
	if ( "quality" in resize ) {
		if ( resize.quality < 0 || resize.quality > 100 ) {
			warning.push("'quality' option is illegal. this option must be in range 0-100.");
		} else {
			stdout.write(magenta + "    Image Quality:    " + reset);
			stdout.write(resize.quality + " (JPG Only)");
			stdout.write("\r\n");
		}
	}
    stdout.write(magenta + "    Save bucket:      " + reset);
    stdout.write(( resize.bucket ) ? resize.bucket : bucket ? bucket : "[Same bucket]");
    stdout.write("\r\n");
    stdout.write(magenta + "    Save directory:   " + reset);
    if ( "directory" in resize ) {
        stdout.write(resize.directory + ( /^\.\//.test(resize.directory) ) ? "[Relative]" : "");
    } else {
        stdout.write("[Same directory]");
    }
    stdout.write("\r\n");
    if ( ! resize.directory && ! resize.bucket && ! bucket ) {
        warning.push(" Image will saving same directory. This may cause infinite process loop at AWS-Lambda.");
    }
    if ( "prefix" in resize ) {
        stdout.write(magenta + "    Filename Prefix:  " + reset + resize.prefix);
        stdout.write("\r\n");
    }
    if ( "suffix" in resize ) {
        stdout.write(magenta + "    Filename Suffix:  " + reset + resize.suffix);
        stdout.write("\r\n");
    }
	stdout.write(magenta + "    S3 ACL:           " + reset);
	stdout.write(( resize.acl ) ? resize.acl : acl ? "[Global ACL]" : "[Source ACL]");
	stdout.write("\r\n");
    stdout.write("\r\n");
});

stdout.write("\r\n");
stdout.write(green + "Configuration check finished.\r\n" + reset);
stdout.write("\r\n");
if ( fatals.length === 0 && warning.length === 0 ) {
    stdout.write(green + "Your configuration is green!\r\n" + reset);
} else {
    fatals.forEach(function(f) {
        stdout.write(red + "[Fatal] " + f + "\r\n" + reset);
    });
    warning.forEach(function(n) {
        stdout.write(red + "[Warning] " + n + "\r\n" + reset);
    });
}

})();
